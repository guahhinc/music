<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA / APP SETTINGS -->
    <title>Guahh Music</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="https://ui-avatars.com/api/?name=Guahh&background=FA233B&color=fff&size=512&font-size=0.5&length=1">
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background-color: #000; 
            color: #fff; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none;
        }
        
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        /* Glassmorphism */
        .glass-panel {
            background: rgba(28, 28, 30, 0.96);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .glass-modal {
            background: rgba(10, 10, 10, 0.98);
            backdrop-filter: blur(40px);
        }
        
        /* Range Slider */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%;
            background: #fff; margin-top: -4px; box-shadow: 0 2px 6px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #333; border-radius: 2px; }
        
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Equalizer Animation */
        .playing-icon { display: flex; align-items: flex-end; height: 12px; width: 14px; gap: 2px; flex-shrink: 0; }
        .playing-bar { width: 3px; background-color: #FA233B; animation: bounce 1s infinite ease-in-out; border-radius: 1px; }
        .playing-bar:nth-child(1) { height: 60%; animation-delay: 0s; }
        .playing-bar:nth-child(2) { height: 100%; animation-delay: 0.2s; }
        .playing-bar:nth-child(3) { height: 40%; animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { height: 40%; } 50% { height: 100%; } }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
    </style>
</head>
<body class="bg-black text-white selection:bg-[#FA233B] selection:text-white overflow-hidden">

    <div id="root"></div>

    <script type="text/babel">
        const SPREADSHEET_ID = "15QpTb5ieYqRoP6LuRKxMnzHysdSY0lXC13M_NseIkHQ"; 
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzv2chmB6Nw8e0MXDpSANpAEuF71rWD7vF0Tr8MQxUQhTzppFyxE81eJNTRiGLU8PQ1Ow/exec";
        const GIDS = { songs: "0", albums: "923389982", artists: "1359156026", users: "490485784", json: "1019835850" };

        const Icon = ({ path, size=20, className="", fill="none" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );

        const Icons = {
            Play: (p) => <Icon {...p} fill={p.fill||"none"} path={<polygon points="5 3 19 12 5 21 5 3"></polygon>} />,
            Pause: (p) => <Icon {...p} fill={p.fill||"none"} path={<><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></>} />,
            SkipBack: (p) => <Icon {...p} path={<><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></>} />,
            SkipForward: (p) => <Icon {...p} path={<><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></>} />,
            Search: (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></>} />,
            Heart: (p) => <Icon {...p} path={<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>} />,
            Home: (p) => <Icon {...p} path={<><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></>} />,
            Library: (p) => <Icon {...p} path={<><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></>} />, 
            Disc: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></>} />,
            User: (p) => <Icon {...p} path={<><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></>} />,
            Music: (p) => <Icon {...p} path={<><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></>} />,
            LogOut: (p) => <Icon {...p} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></>} />,
            CheckCircle: (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></>} />,
            Alert: (p) => <Icon {...p} path={<><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></>} />,
            ChevronDown: (p) => <Icon {...p} path={<polyline points="6 9 12 15 18 9"></polyline>} />,
            Shuffle: (p) => <Icon {...p} path={<><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></>} />
        };

        const GuahhApp = () => {
            const [db, setDb] = React.useState({ songs: [], albums: [], artists: [], users: [], userJson: [] });
            const [status, setStatus] = React.useState('loading'); 
            const [errorMsg, setErrorMsg] = React.useState('');
            const [currentUser, setCurrentUser] = React.useState(null);
            const [userBlob, setUserBlob] = React.useState({ favorites: [], history: [], play_counts: {} });
            
            const [activeTab, setActiveTab] = React.useState('login'); 
            const [selectedItem, setSelectedItem] = React.useState(null);
            const [showFullPlayer, setShowFullPlayer] = React.useState(false);
            
            const [queue, setQueue] = React.useState([]); 
            const [currentSong, setCurrentSong] = React.useState(null);
            const [isPlaying, setIsPlaying] = React.useState(false);
            const [isShuffle, setIsShuffle] = React.useState(false);
            const [volume, setVolume] = React.useState(1);
            
            // Scrubbing
            const [currentTime, setCurrentTime] = React.useState(0);
            const [duration, setDuration] = React.useState(0);
            const [isScrubbing, setIsScrubbing] = React.useState(false);
            const [scrubValue, setScrubValue] = React.useState(0);
            
            const audioRef = React.useRef(new Audio());

            React.useEffect(() => {
                const fetchTab = (gid) => `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=tsv&gid=${gid}`;
                const parseTSV = (url) => new Promise((resolve, reject) => {
                    Papa.parse(url, {
                        download: true, header: true, skipEmptyLines: true,
                        complete: (res) => {
                            if (res.data.length && Object.keys(res.data[0])[0]?.includes("<html")) reject("Sheet ID incorrect or not published.");
                            else resolve(res.data);
                        },
                        error: (err) => reject(err)
                    });
                });

                Promise.all([
                    parseTSV(fetchTab(GIDS.songs)), parseTSV(fetchTab(GIDS.albums)), parseTSV(fetchTab(GIDS.artists)), parseTSV(fetchTab(GIDS.users)), parseTSV(fetchTab(GIDS.json))
                ]).then(([songsRaw, albumsRaw, artistsRaw, usersRaw, jsonRaw]) => {
                    if (!songsRaw.length) throw new Error("Connected, but 'songs' tab is empty.");
                    
                    const enrichedSongs = songsRaw.map(song => {
                        const album = albumsRaw.find(a => a.album_name === song.album_name) || {};
                        const artist = artistsRaw.find(ar => ar.artist_name === album.artist_name) || {};
                        return {
                            ...song,
                            cover_url: album.cover_url || 'https://via.placeholder.com/300/333333/ffffff?text=Music',
                            artist_name: album.artist_name || 'Unknown',
                            artist_image: artist.artist_image || 'https://via.placeholder.com/300/333333/ffffff?text=Artist',
                            year: album.year || ''
                        };
                    });
                    setDb({ songs: enrichedSongs, albums: albumsRaw, artists: artistsRaw, users: usersRaw, userJson: jsonRaw });
                    
                    const savedUser = localStorage.getItem('guahh_user');
                    if (savedUser) {
                        try {
                            const parsed = JSON.parse(savedUser);
                            const verifiedUser = usersRaw.find(u => u.username === parsed.username && u.password === parsed.password);
                            if (verifiedUser) {
                                setCurrentUser(verifiedUser);
                                const jsonRow = jsonRaw.find(row => row.user_id === verifiedUser.user_id);
                                if (jsonRow && jsonRow.data) try { setUserBlob(JSON.parse(jsonRow.data)); } catch(e) {}
                                setActiveTab('listen-now');
                            }
                        } catch(e) { localStorage.removeItem('guahh_user'); }
                    }
                    setStatus('success');
                }).catch(err => { console.error(err); setErrorMsg(err.toString()); setStatus('error'); });
            }, []);

            const getPlayableUrl = (url) => {
                if (!url) return '';
                let cleanUrl = url.trim();
                if (cleanUrl.includes('raw.githubusercontent.com')) {
                    const path = cleanUrl.replace('https://raw.githubusercontent.com/', '');
                    const parts = path.split('/');
                    cleanUrl = `https://cdn.jsdelivr.net/gh/${parts[0]}/${parts[1]}@${parts[2]}/${parts.slice(3).join('/')}`;
                }
                return cleanUrl.replace(/ /g, '%20');
            };

            const playSong = (song, newQueue) => {
                if(newQueue) setQueue(newQueue);
                setCurrentSong(song);
                setIsPlaying(true);
            };

            const togglePlay = (e) => {
                e && e.stopPropagation();
                if(isPlaying) audioRef.current.pause();
                else audioRef.current.play();
                setIsPlaying(!isPlaying);
            };

            const playNext = () => {
                if (!queue.length) return;
                if (isShuffle) {
                    playSong(queue[Math.floor(Math.random() * queue.length)]);
                } else {
                    const nextIndex = (queue.findIndex(s => s.id === currentSong.id) + 1) % queue.length;
                    playSong(queue[nextIndex]);
                }
            };
            
            const playPrev = () => {
                 if (!queue.length) return;
                 const prevIndex = (queue.findIndex(s => s.id === currentSong.id) - 1 + queue.length) % queue.length;
                 playSong(queue[prevIndex]);
            };

            // --- FIXED SCRUBBING LOGIC ---
            const handleScrubStart = (e) => {
                setIsScrubbing(true);
                setScrubValue(Number(e.target.value));
            };

            const handleScrubMove = (e) => {
                setScrubValue(Number(e.target.value));
            };

            const handleScrubEnd = (e) => {
                const newTime = Number(e.target.value);
                audioRef.current.currentTime = newTime;
                setCurrentTime(newTime);
                setIsScrubbing(false);
            };

            React.useEffect(() => {
                audioRef.current.crossOrigin = "anonymous";
                const onTimeUpdate = () => {
                    if (!isScrubbing) setCurrentTime(audioRef.current.currentTime);
                };
                const onLoadedMetadata = () => setDuration(audioRef.current.duration);
                const onEnded = () => playNext();
                
                audioRef.current.addEventListener('timeupdate', onTimeUpdate);
                audioRef.current.addEventListener('loadedmetadata', onLoadedMetadata);
                audioRef.current.addEventListener('ended', onEnded);
                
                const handleVisibilityChange = () => {
                    if (document.hidden && currentUser && currentUser.subscription_status !== 'active' && isPlaying) {
                        audioRef.current.pause();
                        setIsPlaying(false);
                    }
                };
                document.addEventListener("visibilitychange", handleVisibilityChange);
                
                return () => {
                    audioRef.current.removeEventListener('timeupdate', onTimeUpdate);
                    audioRef.current.removeEventListener('loadedmetadata', onLoadedMetadata);
                    audioRef.current.removeEventListener('ended', onEnded);
                    document.removeEventListener("visibilitychange", handleVisibilityChange);
                };
            }, [currentSong, queue, isShuffle, currentUser, isPlaying, isScrubbing]);

            React.useEffect(() => {
                if (currentSong && 'mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: currentSong.title,
                        artist: currentSong.artist_name,
                        album: currentSong.album_name,
                        artwork: [{ src: currentSong.cover_url, sizes: '512x512', type: 'image/jpeg' }]
                    });
                    navigator.mediaSession.setActionHandler('play', () => { audioRef.current.play(); setIsPlaying(true); });
                    navigator.mediaSession.setActionHandler('pause', () => { audioRef.current.pause(); setIsPlaying(false); });
                    navigator.mediaSession.setActionHandler('previoustrack', playPrev);
                    navigator.mediaSession.setActionHandler('nexttrack', playNext);
                }
            }, [currentSong]);

            React.useEffect(() => {
                if (currentSong) {
                    audioRef.current.src = getPlayableUrl(currentSong.audio_url);
                    audioRef.current.volume = volume;
                    audioRef.current.play().catch(e => { console.log("Autoplay blocked"); setIsPlaying(false); });
                    setIsPlaying(true);
                    setTimeout(() => trackPlay(currentSong), 5000);
                }
            }, [currentSong]);

            const openArtist = (artistObj) => { if(artistObj) { setSelectedItem(artistObj); setActiveTab('artist-view'); } };
            const openAlbum = (albumObj) => { if(albumObj) { setSelectedItem(albumObj); setActiveTab('album-view'); } };

            const trackPlay = (song) => {
                if(!currentUser) return;
                const prevHistory = userBlob.history || [];
                const prevCounts = userBlob.play_counts || {};
                const newHistory = [{ id: song.id, date: new Date().toISOString() }, ...prevHistory].slice(0, 50);
                const newCounts = { ...prevCounts, [song.id]: (prevCounts[song.id] || 0) + 1 };
                syncToCloud({ ...userBlob, history: newHistory, play_counts: newCounts });
            };

            const syncToCloud = async (newBlob) => {
                setUserBlob(newBlob);
                if (!currentUser) return;
                try {
                    await fetch(APPS_SCRIPT_URL, {
                        method: 'POST', mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ user_id: currentUser.user_id, data: newBlob })
                    });
                } catch(e) { console.error(e); }
            };

            const toggleFavorite = (e, songId) => {
                e && e.stopPropagation();
                let newFavs = userBlob.favorites || [];
                if (currentUser.subscription_status !== 'active' && !newFavs.includes(songId) && newFavs.length >= 5) {
                    alert("Free Limit Reached! Upgrade to Premium."); return;
                }
                if (newFavs.includes(songId)) newFavs = newFavs.filter(id => id !== songId);
                else newFavs = [...newFavs, songId];
                syncToCloud({ ...userBlob, favorites: newFavs });
            };

            const formatTime = (time) => {
                if(isNaN(time)) return "0:00";
                const m = Math.floor(time / 60);
                const s = Math.floor(time % 60);
                return `${m}:${s < 10 ? '0' : ''}${s}`;
            };
            
            const handleLogin = (u, p) => {
                const user = db.users.find(usr => usr.username === u && usr.password === p);
                if (user) {
                    localStorage.setItem('guahh_user', JSON.stringify(user));
                    setCurrentUser(user);
                    const jsonRow = db.userJson.find(row => row.user_id === user.user_id);
                    if (jsonRow && jsonRow.data) try { setUserBlob(JSON.parse(jsonRow.data)); } catch(e) {}
                    setActiveTab('listen-now');
                } else alert("Invalid Username or Password.");
            };
            
            const handleLogout = () => { localStorage.removeItem('guahh_user'); window.location.reload(); };

            const SongRow = ({ song, index, showAlbum = true, contextQueue }) => {
                const isCurrent = currentSong && currentSong.id === song.id;
                const isFav = (userBlob.favorites || []).includes(song.id);
                return (
                    <div onClick={() => playSong(song, contextQueue)} className={`flex items-center p-2 rounded-lg cursor-pointer group transition border-b border-transparent ${isCurrent ? 'bg-[#1c1c1e]' : 'hover:bg-[#1c1c1e] hover:border-[#333]'}`}>
                        <div className="w-8 text-xs text-gray-500 text-center flex-shrink-0 flex justify-center">
                            {isCurrent && isPlaying ? (
                                <div className="playing-icon"><div className="playing-bar"></div><div className="playing-bar"></div><div className="playing-bar"></div></div>
                            ) : <span className="group-hover:hidden">{index + 1}</span>}
                            <Icons.Play size={12} className="hidden group-hover:block text-white fill-white"/>
                        </div>
                        <img src={song.cover_url} className="w-10 h-10 rounded shadow-sm mx-4 object-cover bg-[#333]"/>
                        <div className="flex-1 min-w-0 mr-4">
                            <div className={`text-sm font-medium truncate ${isCurrent?'text-[#FA233B]':'text-white'}`}>{song.title}</div>
                            <div className="text-xs text-gray-400 truncate">{song.artist_name}</div>
                        </div>
                        {showAlbum && <div className="text-xs text-gray-500 w-32 truncate hidden md:block mr-4">{song.album_name}</div>}
                        <button onClick={(e) => toggleFavorite(e, song.id)} className="p-2 text-gray-500 hover:text-[#FA233B] transition">
                            <Icons.Heart size={16} className={isFav ? "fill-[#FA233B] text-[#FA233B]" : ""}/>
                        </button>
                    </div>
                );
            };

            const BottomTab = ({ id, icon: Icon, label }) => (
                <button onClick={() => { setActiveTab(id); setShowFullPlayer(false); }} className={`flex flex-col items-center justify-center w-full py-1 ${activeTab === id ? 'text-[#FA233B]' : 'text-gray-500'}`}>
                    <Icon size={24} />
                    <span className="text-[10px] mt-1 font-medium">{label}</span>
                </button>
            );

            if (status === 'loading') return <div className="h-screen flex flex-col items-center justify-center bg-black text-white"><div className="animate-spin text-[#FA233B] mb-4"><Icons.Music size={48}/></div></div>;
            if (status === 'error') return <div className="h-screen flex flex-col items-center justify-center bg-black text-white p-6 text-center"><Icons.Alert size={48} className="text-red-500 mx-auto mb-4"/><p>{errorMsg}</p></div>;

            if (activeTab === 'login') return (
                <div className="h-screen w-full flex flex-col items-center justify-center bg-black">
                    <div className="bg-[#1c1c1e] p-8 md:p-10 rounded-2xl border border-[#333] w-full max-w-sm mx-4 fade-in">
                        <div className="flex justify-center mb-8"><div className="w-16 h-16 bg-[#FA233B] rounded-xl flex items-center justify-center text-white shadow-lg"><Icons.Music size={32} /></div></div>
                        <h1 className="text-2xl font-bold text-center text-white mb-2">Guahh ID</h1>
                        <p className="text-center text-gray-500 text-sm mb-6">Sign in to start listening.</p>
                        <div className="space-y-4">
                            <input id="u_in" placeholder="Username" className="w-full bg-[#2c2c2e] text-white p-3 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#FA233B]" />
                            <input id="p_in" type="password" placeholder="Password" className="w-full bg-[#2c2c2e] text-white p-3 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#FA233B]" />
                            <button onClick={() => handleLogin(document.getElementById('u_in').value, document.getElementById('p_in').value)} className="w-full bg-[#FA233B] text-white font-bold py-3 rounded-lg hover:bg-[#d61e32] transition">Sign In</button>
                        </div>
                    </div>
                </div>
            );

            const libraryList = db.songs.filter(s => (userBlob.favorites||[]).includes(s.id));
            const browseList = db.songs;

            return (
                <div className="flex h-screen overflow-hidden bg-black text-white pt-safe">
                    {currentUser && currentUser.subscription_status !== 'active' && <div className="fixed top-0 left-0 right-0 bg-blue-600 text-white text-xs font-bold text-center py-1 z-50 pt-safe">Free Plan • Upgrade for Background Play</div>}

                    <div className="hidden md:flex w-64 bg-[#121212] border-r border-[#222] flex-col pt-8 px-4 pb-24">
                        <div className="px-2 mb-8 flex items-center gap-2 text-[#FA233B]"><Icons.Music size={24}/> <span className="text-white font-bold text-xl">Guahh</span></div>
                        <nav className="space-y-1">
                            {['listen-now', 'browse'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`flex items-center space-x-3 w-full p-2 rounded-lg transition ${activeTab===tab?'bg-[#2c2c2e] text-[#FA233B] font-semibold':'text-gray-400 hover:text-white hover:bg-[#1c1c1e]'}`}>
                                    {tab==='listen-now' ? <Icons.Home size={20}/> : <Icons.Search size={20}/>} <span className="capitalize text-sm">{tab.replace('-', ' ')}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="mt-8 px-2">
                            <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Library</h3>
                            <nav className="space-y-1">
                                {['library', 'albums', 'artists'].map(t => <button key={t} onClick={()=>setActiveTab(t)} className={`flex items-center space-x-3 w-full p-2 rounded-lg transition ${activeTab===t?'bg-[#2c2c2e] text-[#FA233B] font-semibold':'text-gray-400 hover:text-white hover:bg-[#1c1c1e]'}`}>{t==='library'?<Icons.Library size={20}/>:t==='albums'?<Icons.Disc size={20}/>:<Icons.User size={20}/>}<span className="capitalize text-sm">{t==='library'?'Songs':t}</span></button>)}
                            </nav>
                        </div>
                        <div className="mt-auto mb-4 p-3 bg-[#1c1c1e] border border-[#333] rounded-xl shadow-sm flex items-center gap-3">
                            <div className="w-8 h-8 rounded-full bg-[#FA233B] flex items-center justify-center text-white text-xs font-bold">{currentUser.username[0].toUpperCase()}</div>
                            <div className="flex-1 overflow-hidden">
                                <div className="text-xs font-bold truncate">{currentUser.username}</div>
                                <div className="text-[10px] text-gray-400 uppercase flex items-center gap-1">{currentUser.subscription_status === 'active' ? <Icons.CheckCircle size={10} className="text-green-500"/> : <Icons.Alert size={10}/>} {currentUser.subscription_status === 'active' ? 'Premium' : 'Free'}</div>
                            </div>
                            <button onClick={handleLogout} className="text-gray-400 hover:text-red-500"><Icons.LogOut size={16}/></button>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto bg-black pb-40 md:pb-24 pt-8">
                        {activeTab === 'listen-now' && (
                            <div className="p-6 md:p-10 space-y-10 fade-in">
                                <h1 className="text-3xl font-bold mb-4">Listen Now</h1>
                                <section>
                                    <h2 className="text-xl font-bold mb-4 border-b border-[#333] pb-2 text-gray-200">Top Albums</h2>
                                    <div className="grid grid-cols-2 md:grid-cols-5 gap-4 md:gap-6">
                                        {db.albums.slice(0,5).map(a => (
                                            <div key={a.album_name} onClick={() => openAlbum(a)} className="group cursor-pointer">
                                                <div className="aspect-square bg-[#333] rounded-lg overflow-hidden mb-3 shadow-lg"><img src={a.cover_url} className="w-full h-full object-cover"/></div>
                                                <div className="text-sm font-semibold truncate text-white">{a.album_name}</div>
                                                <div className="text-xs text-gray-400 truncate">{a.artist_name}</div>
                                            </div>
                                        ))}
                                    </div>
                                </section>
                                <section>
                                    <h2 className="text-xl font-bold mb-4 border-b border-[#333] pb-2 text-gray-200">New Releases</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        {db.songs.slice(-6).reverse().map((s,i) => (
                                            <div key={s.id} onClick={() => playSong(s, db.songs.slice(-6).reverse())} className="flex items-center p-2 bg-[#1c1c1e] rounded-lg cursor-pointer border border-[#333]">
                                                <img src={s.cover_url} className="w-12 h-12 rounded shadow-sm mr-4 object-cover bg-[#333]"/>
                                                <div className="flex-1 min-w-0">
                                                    <div className={`text-sm font-medium truncate ${currentSong?.id===s.id?'text-[#FA233B]':'text-white'}`}>{s.title}</div>
                                                    <div className="text-xs text-gray-400 truncate">{s.artist_name}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </section>
                            </div>
                        )}

                        {(activeTab === 'browse' || activeTab === 'library') && (
                            <div className="p-6 md:p-10 fade-in">
                                <div className="flex items-center justify-between mb-8">
                                    <h1 className="text-3xl font-bold capitalize">{activeTab === 'library' ? 'Songs' : 'Browse'}</h1>
                                    {activeTab === 'library' && (
                                        <button onClick={() => { setIsShuffle(!isShuffle); playSong(libraryList[Math.floor(Math.random()*libraryList.length)], libraryList); }} className="flex items-center gap-2 bg-[#1c1c1e] px-4 py-2 rounded-lg text-[#FA233B] text-sm font-bold hover:bg-[#2c2c2e]">
                                            <Icons.Shuffle size={16}/> Shuffle
                                        </button>
                                    )}
                                </div>
                                <div className="space-y-1">
                                    {activeTab === 'library' && !libraryList.length && <div className="py-20 text-center text-gray-500"><Icons.Heart size={48} className="mx-auto mb-4 opacity-20"/><p>No songs.</p></div>}
                                    {activeTab === 'browse' && browseList.map((s,i) => <SongRow key={s.id} song={s} index={i} contextQueue={browseList} />)}
                                    {activeTab === 'library' && libraryList.map((s,i) => <SongRow key={s.id} song={s} index={i} contextQueue={libraryList} />)}
                                </div>
                            </div>
                        )}

                        {activeTab === 'albums' && (
                             <div className="p-6 md:p-10 fade-in">
                                 <h1 className="text-3xl font-bold mb-8">Albums</h1>
                                 <div className="grid grid-cols-2 md:grid-cols-5 gap-6">
                                    {db.albums.map(a => (
                                        <div key={a.album_name} onClick={() => openAlbum(a)} className="group cursor-pointer">
                                            <div className="aspect-square bg-[#333] rounded-lg overflow-hidden mb-3 shadow-lg"><img src={a.cover_url} className="w-full h-full object-cover"/></div>
                                            <div className="text-sm font-semibold truncate text-white">{a.album_name}</div>
                                            <div className="text-xs text-gray-400 truncate">{a.artist_name}</div>
                                        </div>
                                    ))}
                                 </div>
                             </div>
                        )}

                        {activeTab === 'artists' && (
                             <div className="p-6 md:p-10 fade-in">
                                 <h1 className="text-3xl font-bold mb-8">Artists</h1>
                                 <div className="grid grid-cols-3 md:grid-cols-6 gap-6">
                                    {db.artists.map(a => (
                                        <div key={a.artist_name} onClick={() => openArtist(a)} className="group cursor-pointer text-center">
                                            <div className="aspect-square bg-[#333] rounded-full overflow-hidden mb-3 shadow-lg mx-auto border-2 border-transparent group-hover:border-[#FA233B] transition"><img src={a.artist_image} className="w-full h-full object-cover"/></div>
                                            <div className="text-sm font-semibold truncate text-white">{a.artist_name}</div>
                                        </div>
                                    ))}
                                 </div>
                             </div>
                        )}

                        {activeTab === 'album-view' && selectedItem && (
                            <div className="fade-in">
                                <div className="p-6 md:p-10 flex flex-col md:flex-row gap-8 md:items-end bg-gradient-to-b from-[#222] to-black">
                                    <div className="w-48 h-48 md:w-64 md:h-64 shadow-2xl rounded-lg overflow-hidden bg-[#1c1c1e] mx-auto md:mx-0"><img src={selectedItem.cover_url} className="w-full h-full object-cover" /></div>
                                    <div className="flex-1 text-center md:text-left">
                                        <h2 className="text-sm font-bold uppercase text-white opacity-80 mb-1">Album</h2>
                                        <h1 className="text-3xl md:text-5xl font-extrabold mb-2 tracking-tight">{selectedItem.album_name}</h1>
                                        <div className="flex items-center justify-center md:justify-start gap-2 text-sm font-bold text-gray-300">
                                            <span onClick={() => {
                                                const art = db.artists.find(ar => ar.artist_name === selectedItem.artist_name);
                                                if(art) openArtist(art);
                                            }} className="cursor-pointer hover:text-white underline decoration-gray-500 hover:decoration-white transition">{selectedItem.artist_name}</span> 
                                            <span className="text-gray-500">• {selectedItem.year || '2023'}</span>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-4 md:p-10">
                                    {db.songs.filter(s => s.album_name === selectedItem.album_name).map((s, i, arr) => <SongRow key={s.id} song={s} index={i} showAlbum={false} contextQueue={arr} />)}
                                </div>
                            </div>
                        )}

                        {activeTab === 'artist-view' && selectedItem && (
                            <div className="fade-in">
                                <div className="h-64 md:h-80 relative overflow-hidden">
                                    <div className="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent z-10"></div>
                                    <img src={selectedItem.artist_image} className="w-full h-full object-cover opacity-60" />
                                    <div className="absolute bottom-6 left-6 z-20"><h1 className="text-4xl md:text-6xl font-extrabold tracking-tight">{selectedItem.artist_name}</h1></div>
                                </div>
                                <div className="p-6 md:p-10">
                                    <h2 className="text-xl font-bold mb-4">Top Songs</h2>
                                    <div className="mb-10">{db.songs.filter(s => s.artist_name === selectedItem.artist_name).slice(0, 5).map((s, i, arr) => <SongRow key={s.id} song={s} index={i} contextQueue={arr} />)}</div>
                                    
                                    <h2 className="text-xl font-bold mb-4">Albums</h2>
                                    <div className="grid grid-cols-2 md:grid-cols-5 gap-6">
                                        {db.albums.filter(a => a.artist_name === selectedItem.artist_name).map(a => (
                                            <div key={a.album_name} onClick={() => openAlbum(a)} className="group cursor-pointer">
                                                <div className="aspect-square bg-[#333] rounded-lg overflow-hidden mb-3 shadow-lg"><img src={a.cover_url} className="w-full h-full object-cover"/></div>
                                                <div className="text-sm font-semibold truncate text-white">{a.album_name}</div>
                                                <div className="text-xs text-gray-400 truncate">{a.year}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="md:hidden fixed bottom-0 w-full bg-[#1c1c1e]/95 backdrop-blur-xl border-t border-[#333] flex justify-around py-3 pb-safe z-40">
                        <BottomTab id="listen-now" icon={Icons.Home} label="Listen Now" />
                        <BottomTab id="browse" icon={Icons.Search} label="Browse" />
                        <BottomTab id="library" icon={Icons.Library} label="Library" />
                        <BottomTab id="albums" icon={Icons.Disc} label="Albums" />
                    </div>

                    <div onClick={() => setShowFullPlayer(true)} className={`fixed left-0 right-0 glass-panel z-50 flex items-center px-4 md:px-6 justify-between transition-all duration-300 ${activeTab==='login'?'hidden':'flex'} bottom-[60px] md:bottom-0 h-16 md:h-20 border-b md:border-b-0 border-[#333] cursor-pointer hover:bg-[#2c2c2e]`}>
                        <div className="flex-1 flex items-center gap-3 overflow-hidden">
                            {currentSong ? (
                                <>
                                    <img src={currentSong.cover_url} className="w-10 h-10 md:w-12 md:h-12 rounded-md bg-[#333] object-cover flex-shrink-0"/>
                                    <div className="min-w-0">
                                        <div className="text-sm font-semibold text-white truncate">{currentSong.title}</div>
                                        <div className="text-xs text-gray-400 truncate">{currentSong.artist_name}</div>
                                    </div>
                                </>
                            ) : <div className="text-sm text-gray-500 pl-2">Not Playing</div>}
                        </div>
                        <div className="flex items-center gap-4 md:gap-6 mr-2">
                             <button onClick={(e) => { e.stopPropagation(); togglePlay(); }} className="w-8 h-8 md:w-10 md:h-10 bg-white text-black rounded-full flex items-center justify-center shadow-lg active:scale-95">
                                {isPlaying ? <Icons.Pause size={16} fill="black"/> : <Icons.Play size={16} fill="black" className="ml-0.5"/>}
                            </button>
                            <button onClick={(e) => { e.stopPropagation(); playNext(); }} className="hidden md:block text-gray-400 hover:text-white"><Icons.SkipForward size={24} className="fill-current"/></button>
                        </div>
                    </div>

                    {showFullPlayer && currentSong && (
                        <div className="fixed inset-0 z-[60] glass-modal flex flex-col slide-up pt-safe">
                            <div className="flex justify-center pt-6 pb-2 relative">
                                <button onClick={() => setShowFullPlayer(false)} className="bg-[#333] w-12 h-1 rounded-full opacity-50"></button>
                                <button onClick={() => setShowFullPlayer(false)} className="absolute right-6 top-6 text-gray-400"><Icons.ChevronDown size={32}/></button>
                            </div>
                            
                            <div className="flex-1 flex flex-col justify-center px-8 md:px-20 max-w-4xl mx-auto w-full">
                                <div className="aspect-square w-full max-h-[50vh] bg-[#333] rounded-xl shadow-2xl overflow-hidden mb-8 md:mb-12 self-center">
                                    <img src={currentSong.cover_url} className="w-full h-full object-cover" />
                                </div>
                                
                                <div className="flex items-end justify-between mb-6">
                                    <div>
                                        <h2 className="text-2xl md:text-3xl font-bold text-white mb-1 line-clamp-1">{currentSong.title}</h2>
                                        <h3 className="text-lg text-gray-400 md:text-xl line-clamp-1">{currentSong.artist_name}</h3>
                                    </div>
                                    <button onClick={(e) => toggleFavorite(e, currentSong.id)} className="p-3 bg-[#1c1c1e] rounded-full text-gray-400">
                                         <Icons.Heart size={24} className={(userBlob.favorites||[]).includes(currentSong.id) ? "fill-[#FA233B] text-[#FA233B]" : ""}/>
                                    </button>
                                </div>

                                <div className="mb-2">
                                    <input 
                                        type="range" 
                                        min="0" 
                                        max={duration || 0} 
                                        value={isScrubbing ? scrubValue : currentTime} 
                                        onMouseDown={handleScrubStart}
                                        onTouchStart={handleScrubStart}
                                        onChange={handleScrubMove}
                                        onMouseUp={handleScrubEnd}
                                        onTouchEnd={handleScrubEnd}
                                        className="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer"
                                    />
                                </div>
                                <div className="flex justify-between text-xs text-gray-400 font-medium mb-8"><span>{formatTime(isScrubbing ? scrubValue : currentTime)}</span><span>{formatTime(duration)}</span></div>

                                <div className="flex items-center justify-between max-w-md mx-auto w-full mb-12">
                                    <button onClick={() => setIsShuffle(!isShuffle)} className={`text-gray-400 hover:text-white ${isShuffle ? 'text-[#FA233B]' : ''}`}><Icons.Shuffle size={24}/></button>
                                    <button onClick={playPrev} className="text-white hover:scale-110 transition"><Icons.SkipBack size={42} fill="white"/></button>
                                    <button onClick={(e) => togglePlay(e)} className="w-20 h-20 bg-white text-black rounded-full flex items-center justify-center shadow-xl hover:scale-105 transition">
                                        {isPlaying ? <Icons.Pause size={32} fill="black"/> : <Icons.Play size={32} fill="black" className="ml-1"/>}
                                    </button>
                                    <button onClick={playNext} className="text-white hover:scale-110 transition"><Icons.SkipForward size={42} fill="white"/></button>
                                    <div className="w-6"></div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GuahhApp />);
    </script>
</body>
</html>
