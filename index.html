<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guahh Music+</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,1,0" />
    <style>
        :root {
            --primary-color: #fb374f;
            --background-color: #000000;
            --surface-color: #121212;
            --surface-color-light: #1a1a1a;
            --text-color: #ffffff;
            --text-color-secondary: #b3b3bb;
        }

        /* Basic Setup */
        body { background-color: var(--background-color); color: var(--text-color); font-family: 'Inter', sans-serif; margin: 0; padding: 0; overflow: hidden; }
        .material-symbols-rounded {
             -webkit-user-select: none; /* Safari */
             -ms-user-select: none; /* IE 10 and IE 11 */
             user-select: none; /* Standard syntax */
        }

        /* Main App Layout */
        .desktop-container { display: grid; grid-template-columns: 240px 1fr; grid-template-rows: 1fr 90px; height: 100vh; width: 100vw; }

        /* --- Sidebar Navigation --- */
        .sidebar { grid-column: 1 / 2; grid-row: 1 / 2; background-color: #000; padding: 24px; display: flex; flex-direction: column; }
        .sidebar h1 { color: var(--primary-color); font-size: 24px; font-weight: 700; margin: 0 0 40px 0; }
        .nav-menu { list-style: none; padding: 0; margin: 0; }
        .nav-menu li { display: flex; align-items: center; padding: 15px 10px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; color: var(--text-color-secondary); transition: background-color 0.3s, color 0.3s; }
        .nav-menu li .material-symbols-rounded { margin-right: 15px; font-size: 28px; }
        .nav-menu li:hover { color: var(--text-color); }
        .nav-menu li.active { background-color: var(--surface-color-light); color: var(--text-color); }

        /* --- Main Content Area --- */
        .main-content { grid-column: 2 / 3; grid-row: 1 / 2; background: var(--surface-color); overflow-y: auto; position: relative; }
        .page { display: none; padding: 30px; position: relative; }
        .page.active { display: block; }
        .page-header { font-size: 28px; font-weight: 700; margin-bottom: 30px; }
        
        /* Home Page & Grids */
        .content-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 24px; }
        .album-card { background-color: var(--surface-color-light); padding: 16px; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; }
        .album-card:hover { background-color: #282828; }
        .album-card img { width: 100%; border-radius: 6px; margin-bottom: 15px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5); }
        .album-card h3, .album-card p { margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .album-card h3 { font-size: 16px; font-weight: 600; margin-bottom: 5px; }
        .album-card p { font-size: 14px; color: var(--text-color-secondary); }

        .artist-card { text-align: center; cursor: pointer; }
        .artist-card img { width: 100%; height: auto; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 50%; margin-bottom: 15px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5); transition: transform 0.3s; }
        .artist-card:hover img { transform: scale(1.05); }
        .artist-card h3 { font-size: 16px; font-weight: 600; margin: 0; }

        #library-empty-message { color: var(--text-color-secondary); }

        /* Album & Artist Pages */
        .artist-page-header, .album-page-header { display: flex; align-items: flex-end; gap: 24px; margin-bottom: 40px; }
        .album-page-cover { width: 230px; height: 230px; object-fit: cover; border-radius: 8px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5); }
        .artist-pfp { width: 230px; height: 230px; object-fit: cover; border-radius: 50%; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5); }
        .page-info p { font-size: 14px; font-weight: 600; text-transform: uppercase; margin: 0 0 10px 0; }
        .page-info h1 { font-size: 72px; font-weight: 900; margin: 0 0 10px 0; line-height: 1; }
        .page-info h2 { font-size: 16px; font-weight: 400; color: var(--text-color-secondary); margin: 0; cursor: pointer; }
        .page-info h2:hover { text-decoration: underline; }
        
        .page-action-button { position: absolute; top: 35px; right: 35px; display: flex; align-items: center; gap: 10px; background-color: var(--surface-color-light); padding: 10px 20px; border-radius: 50px; font-weight: 600; font-size: 14px; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .page-action-button:hover { background-color: #282828; }
        .page-action-button .material-symbols-rounded { font-size: 28px; }
        .page-action-button.added { color: var(--primary-color); background-color: rgba(251, 55, 79, 0.1); }
        .page-action-button.added:hover { background-color: rgba(251, 55, 79, 0.2); }

        /* Universal Song List Table */
        .song-list-table { width: 100%; border-collapse: collapse; }
        .song-list-table td { text-align: left; padding: 15px 10px; font-size: 15px; vertical-align: middle; }
        .song-list-table tr { cursor: pointer; border-radius: 4px; }
        .song-list-table tr:hover { background-color: rgba(255, 255, 255, 0.05); }
        .song-list-table tr.playing .song-title-cell { color: var(--primary-color); }
        .song-title-cell { width: 100%; }
        
        /* Queue & Context Menu */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
        .modal-content { padding: 30px; background-color: var(--surface-color-light); border-radius: 12px; position: relative; max-width: 500px; width: 90%; max-height: 70vh; display: flex; flex-direction: column; }
        .close-btn { position: absolute; top: 10px; right: 20px; color: var(--text-color-secondary); font-size: 30px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: var(--text-color); }
        .modal-content h2 { margin: 0 0 20px 0; }
        #queue-list-container { overflow-y: auto; }
        #queue-list { list-style: none; padding: 0; margin: 0; }
        #queue-list li { display: flex; align-items: center; gap: 15px; padding: 10px; border-radius: 6px; }
        #queue-list li:hover { background-color: #282828; }
        #queue-list img { width: 40px; height: 40px; border-radius: 4px; }
        #queue-list .song-details-container { flex-grow: 1; cursor: pointer; }
        #queue-list .song-details h3 { font-size: 15px; margin: 0; }
        #queue-list .song-details p { font-size: 13px; margin: 2px 0 0 0; color: var(--text-color-secondary); }
        .remove-from-queue-btn { cursor: pointer; color: var(--text-color-secondary); padding: 5px; }
        .remove-from-queue-btn:hover { color: var(--text-color); }

        #context-menu { display: none; position: fixed; z-index: 1001; background-color: #282828; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); padding: 5px; }
        #context-menu ul { list-style: none; padding: 0; margin: 0; }
        #context-menu li { padding: 10px 15px; cursor: pointer; font-size: 14px; border-radius: 4px; }
        #context-menu li:hover { background-color: #3e3e3e; }

        /* Player Bar */
        .player-bar { grid-area: 2 / 1 / 3 / 3; background-color: var(--surface-color-light); border-top: 1px solid #282828; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .player-info { display: flex; align-items: center; gap: 15px; width: 30%; min-width: 0; }
        #player-album-cover { width: 56px; height: 56px; border-radius: 4px; object-fit: cover; background-color: #282828; }
        .player-info-text { overflow: hidden; }
        #player-song-title { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #player-song-artist { font-size: 12px; color: var(--text-color-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .player-controls { display: flex; flex-direction: column; align-items: center; width: 40%; }
        .player-buttons { display: flex; align-items: center; gap: 16px; margin-bottom: 8px; }
        .player-buttons button { background: none; border: none; color: var(--text-color-secondary); cursor: pointer; }
        .player-buttons button:hover { color: var(--text-color); }
        .player-buttons .material-symbols-rounded { font-size: 28px; }
        #play-pause-btn { background-color: var(--primary-color); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; font-size: 28px; }
        #play-pause-btn .material-symbols-rounded { font-size: 28px; }
        .progress-container { width: 100%; display: flex; align-items: center; gap: 10px; font-size: 12px; color: var(--text-color-secondary); }
        #progress-bar { width: 100%; height: 4px; background-color: #535353; border-radius: 2px; cursor: pointer; }
        #progress { width: 0%; height: 100%; background-color: var(--primary-color); border-radius: 2px; }
        .other-controls { display: flex; align-items: center; justify-content: flex-end; width: 30%; }
        #queue-btn { cursor: pointer; color: var(--text-color-secondary); }
        #queue-btn:hover { color: var(--text-color); }
    </style>
</head>
<body>

    <div class="desktop-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h1>Guahh Music+</h1>
            <ul class="nav-menu">
                <li class="nav-item active" data-page="home"><span class="material-symbols-rounded">home</span> Home</li>
                <li class="nav-item" data-page="search"><span class="material-symbols-rounded">search</span> Search</li>
                <li class="nav-item" data-page="library"><span class="material-symbols-rounded">library_music</span> Library</li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div id="home" class="page active">
                <h2 class="page-header">Top Artists</h2><div id="home-artists-grid" class="content-grid"></div>
                <h2 class="page-header" style="margin-top: 40px;">Recently Played</h2><div id="home-albums-grid" class="content-grid"></div>
            </div>
            <div id="library" class="page"><h2 class="page-header">Library</h2><div id="library-container"></div></div>
            <div id="album-view" class="page"></div>
            <div id="artist-view" class="page"></div>
        </main>
        
        <!-- Queue Modal -->
        <div id="queue-modal" class="modal">
            <div class="modal-content">
                <span id="close-queue-btn" class="close-btn">&times;</span><h2>Play Queue</h2>
                <div id="queue-list-container"><ul id="queue-list"></ul></div>
            </div>
        </div>

        <!-- Context Menu -->
        <div id="context-menu">
            <ul>
                <li id="play-next">Play Next</li>
                <li id="add-to-queue">Add to Queue</li>
            </ul>
        </div>

        <!-- Player Bar -->
        <footer class="player-bar">
             <div class="player-info">
                 <img id="player-album-cover" src="" alt="Album Cover">
                 <div class="player-info-text">
                     <div id="player-song-title">Select a song</div>
                     <div id="player-song-artist"></div>
                 </div>
             </div>
             <div class="player-controls">
                 <div class="player-buttons">
                    <button id="prev-btn" class="material-symbols-rounded">skip_previous</button>
                    <button id="play-pause-btn"><span class="material-symbols-rounded">play_arrow</span></button>
                    <button id="next-btn" class="material-symbols-rounded">skip_next</button>
                 </div>
                 <div class="progress-container">
                     <span id="current-time">0:00</span>
                     <div id="progress-bar"><div id="progress"></div></div>
                     <span id="duration">0:00</span>
                 </div>
             </div>
             <div class="other-controls">
                 <span id="queue-btn" class="material-symbols-rounded">queue_music</span>
             </div>
        </footer>
    </div>
    
    <audio id="audio-player" preload="metadata"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const API_KEY = "AIzaSyDS3Vi4dS9ovq_Knc4G7luevb8bWIYrAK8";
            
            // --- NEW: Added robust data loading with error handling ---
            let songList;
            try {
                const response = await fetch('music-data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                songList = await response.json();
            } catch (error) {
                console.error("Error loading music data:", error);
                const mainContent = document.querySelector('.main-content');
                mainContent.innerHTML = `<div style="padding: 30px; text-align: center;">
                                            <h2>Failed to Load Music Data</h2>
                                            <p>This can happen if you open the HTML file directly from your computer.</p>
                                            <p>For local testing, please use a development server like VS Code's "Live Server" extension.</p>
                                            <p style="color: #b3b3bb; font-size: 14px;">Error details: ${error.message}</p>
                                         </div>`;
                return; // Stop the rest of the script from running
            }
            // --- END NEW ---

            const artistPfpData = {
                "Drake": "https://raw.githubusercontent.com/guahhinc/music/main/pfps/drake.png"
                // Add more artists here, like:
                // "Sabrina Carpenter": "https://path/to/her/image.png"
            };
            
            let currentSongIndex = -1;
            let isPlaying = false;
            let library = { albums: new Set() };
            let playQueue = [];

            const audioPlayer = document.getElementById('audio-player');
            const navItems = document.querySelectorAll('.nav-item');
            const pages = document.querySelectorAll('.page');
            const homeArtistsGrid = document.getElementById('home-artists-grid');
            const homeAlbumsGrid = document.getElementById('home-albums-grid');
            const libraryContainer = document.getElementById('library-container');
            const albumViewPage = document.getElementById('album-view');
            const artistViewPage = document.getElementById('artist-view');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const playerSongTitle = document.getElementById('player-song-title');
            const playerSongArtist = document.getElementById('player-song-artist');
            const playerAlbumCover = document.getElementById('player-album-cover');
            const queueModal = document.getElementById('queue-modal');
            const closeQueueBtn = document.getElementById('close-queue-btn');
            const queueBtn = document.getElementById('queue-btn');
            const contextMenu = document.getElementById('context-menu');

            function loadLibrary() { const saved = JSON.parse(localStorage.getItem('guahh_music_library')); if (saved) { library.albums = new Set(saved.albums); } }
            function saveLibrary() { localStorage.setItem('guahh_music_library', JSON.stringify({ albums: [...library.albums] })); }
            
            function toggleAlbumInLibrary(albumName) {
                const button = document.getElementById('page-action-btn');
                const text = button.querySelector('span:first-child');
                const icon = button.querySelector('.material-symbols-rounded');
                if (library.albums.has(albumName)) {
                    library.albums.delete(albumName);
                    text.textContent = "Add to Library"; icon.textContent = "add_circle"; button.classList.remove('added');
                } else {
                    library.albums.add(albumName);
                    text.textContent = "Remove from Library"; icon.textContent = "check_circle"; button.classList.add('added');
                }
                saveLibrary();
                if (document.querySelector('.page.active').id === 'library') renderLibrary();
            }

            // --- Queue Management ---
            function playNext(index) { playQueue.unshift(index); }
            function addToQueue(index) { playQueue.push(index); }
            function renderQueueModal() {
                const queueList = document.getElementById('queue-list');
                if (playQueue.length === 0) { queueList.innerHTML = '<li><p>The queue is empty.</p></li>'; return; }
                queueList.innerHTML = playQueue.map((songIndex, queueIndex) => {
                    const song = songList[songIndex];
                    return `<li data-song-index="${songIndex}" data-queue-index="${queueIndex}">
                                <img src="${song.cover}" alt="${song.album}">
                                <div class="song-details-container">
                                    <div class="song-details">
                                        <h3>${song.title}</h3>
                                        <p>${song.artist}</p>
                                    </div>
                                </div>
                                <span class="material-symbols-rounded remove-from-queue-btn">close</span>
                            </li>`;
                }).join('');
                
                queueList.querySelectorAll('.song-details-container').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const listItem = e.currentTarget.parentElement;
                        const songIndexToPlay = parseInt(listItem.dataset.songIndex);
                        const queueIndexToPlay = parseInt(listItem.dataset.queueIndex);
                        playQueue.splice(0, queueIndexToPlay);
                        playSong(songIndexToPlay);
                        playQueue.shift(); // Remove the song we just started playing
                        queueModal.style.display = 'none';
                    });
                });

                queueList.querySelectorAll('.remove-from-queue-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const queueIndexToRemove = parseInt(e.currentTarget.parentElement.dataset.queueIndex);
                        playQueue.splice(queueIndexToRemove, 1);
                        renderQueueModal(); // Re-render the queue
                    });
                });
            }

            // --- Playback ---
            function playSong(index) {
                if (index < 0 || index >= songList.length) return;
                const song = songList[index];
                updatePlayerInfo(song);
                updatePlaylistHighlight(index);
                currentSongIndex = index;
                audioPlayer.src = `https://www.googleapis.com/drive/v3/files/${song.fileId}?key=${API_KEY}&alt=media`;
                const playPromise = audioPlayer.play();
                if (playPromise) {
                    playPromise.then(() => { isPlaying = true; playPauseBtn.innerHTML = '<span class="material-symbols-rounded">pause</span>'; })
                        .catch(e => {
                            console.error(`Playback failed for "${song.title}":`, e);
                            playerSongTitle.textContent = "Error playing song"; isPlaying = false; playPauseBtn.innerHTML = '<span class="material-symbols-rounded">play_arrow</span>';
                        });
                }
            }
            function togglePlayPause() {
                if (currentSongIndex === -1 && songList.length > 0) { playSong(0); return; }
                if (isPlaying) { audioPlayer.pause(); isPlaying = false; playPauseBtn.innerHTML = '<span class="material-symbols-rounded">play_arrow</span>'; } 
                else if (currentSongIndex !== -1) { audioPlayer.play().then(() => { isPlaying = true; playPauseBtn.innerHTML = '<span class="material-symbols-rounded">pause</span>'; }); }
            }
            function playNextSong() {
                if (playQueue.length > 0) { const nextSongIndex = playQueue.shift(); playSong(nextSongIndex); } 
                else {
                    const nextIndex = (currentSongIndex + 1) % songList.length;
                    playSong(nextIndex);
                }
            }
            function playPrevSong() {
                // If song has played for more than 3 seconds, restart it. Otherwise, go to previous.
                if (audioPlayer.currentTime > 3) {
                    audioPlayer.currentTime = 0;
                } else {
                    const prevIndex = (currentSongIndex - 1 + songList.length) % songList.length;
                    playSong(prevIndex);
                }
            }

            function updatePlayerInfo(song) { 
                playerSongTitle.textContent = song.title; 
                playerSongArtist.textContent = song.artist;
                playerAlbumCover.src = song.cover;
            }
            
            // --- UI Rendering ---
            function showPage(pageId) { pages.forEach(p => p.classList.remove('active')); document.getElementById(pageId).classList.add('active'); }
            
            function renderHomePage() {
                const artists = [...new Map(songList.map(s => [s.artist, s])).values()];
                const albums = [...new Map(songList.map(s => [s.album, s])).values()];
                homeArtistsGrid.innerHTML = artists.map(a => `<div class="artist-card" data-artist-name="${a.artist}"><img src="${artistPfpData[a.artist] || a.cover}" alt="${a.artist}"><h3>${a.artist}</h3></div>`).join('');
                homeAlbumsGrid.innerHTML = albums.map(a => `<div class="album-card" data-album-name="${a.album}"><img src="${a.cover}" alt="${a.album} Cover"><h3>${a.album}</h3><p>${a.artist}</p></div>`).join('');
                homeArtistsGrid.querySelectorAll('.artist-card').forEach(c => c.addEventListener('click', () => showArtistPage(c.dataset.artistName)));
                homeAlbumsGrid.querySelectorAll('.album-card').forEach(c => c.addEventListener('click', () => showAlbumPage(c.dataset.albumName)));
            }
            
            function renderLibrary() {
                if (library.albums.size === 0) { libraryContainer.innerHTML = `<p id="library-empty-message">Your library is empty. Add albums to see them here.</p>`; return; }
                const librarySongs = songList.filter(s => library.albums.has(s.album));
                const albums = [...new Map(librarySongs.map(s => [s.album, s])).values()];
                libraryContainer.innerHTML = `<div class="content-grid">${albums.map(a => `<div class="album-card" data-album-name="${a.album}"><img src="${a.cover}" alt="${a.album} Cover"><h3>${a.album}</h3><p>${a.artist}</p></div>`).join('')}</div>`;
                libraryContainer.querySelectorAll('.album-card').forEach(c => c.addEventListener('click', () => showAlbumPage(c.dataset.albumName)));
            }

            function showAlbumPage(albumName) {
                const albumSongs = songList.map((s, i) => ({...s, originalIndex: i})).filter(s => s.album === albumName);
                const a = albumSongs[0];
                const isAdded = library.albums.has(a.album);
                albumViewPage.innerHTML = `
                    <div id="page-action-btn" class="page-action-button ${isAdded ? 'added' : ''}">
                        <span>${isAdded ? 'Remove from Library' : 'Add to Library'}</span><span class="material-symbols-rounded">${isAdded ? 'check_circle' : 'add_circle'}</span>
                    </div>
                    <div class="album-page-header">
                        <img src="${a.cover}" class="album-page-cover"><div class="page-info"><p>Album</p><h1>${a.album}</h1><h2 onclick="showArtistPage(window.encodeURIComponent('${a.artist}'))">${a.artist}</h2></div>
                    </div>
                    <table class="song-list-table"><tbody>${albumSongs.map(s => `<tr data-index="${s.originalIndex}"><td class="song-title-cell">${s.title}</td></tr>`).join('')}</tbody></table>`;
                albumViewPage.querySelector('#page-action-btn').addEventListener('click', () => toggleAlbumInLibrary(albumName));
                addClickHandlersToRows(albumViewPage);
                updatePlaylistHighlight(currentSongIndex);
                showPage('album-view');
            }
            
            function showArtistPage(artistName) {
                artistName = window.decodeURIComponent(artistName);
                const artistSongs = songList.filter(s => s.artist === artistName);
                const artistInfo = artistSongs[0];
                const artistAlbums = [...new Map(artistSongs.map(s => [s.album, s])).values()];
                artistViewPage.innerHTML = `
                    <div class="artist-page-header">
                        <img src="${artistPfpData[artistInfo.artist] || artistInfo.cover}" class="artist-pfp"><div class="page-info"><p>Artist</p><h1>${artistInfo.artist}</h1></div>
                    </div>
                    <h2 class="page-header">Albums</h2>
                    <div class="content-grid">${artistAlbums.map(album => `<div class="album-card" data-album-name="${album.album}"><img src="${album.cover}" alt="${album.album} Cover"><h3>${album.album}</h3><p>${album.artist}</p></div>`).join('')}</div>`;
                artistViewPage.querySelectorAll('.album-card').forEach(c => { c.addEventListener('click', () => showAlbumPage(c.dataset.albumName)); });
                showPage('artist-view');
            }

            function addClickHandlersToRows(container) {
                container.querySelectorAll('tbody tr').forEach(row => {
                    const index = parseInt(row.dataset.index);
                    row.addEventListener('click', () => playSong(index));
                    row.addEventListener('contextmenu', e => {
                        e.preventDefault();
                        contextMenu.style.top = `${e.clientY}px`;
                        contextMenu.style.left = `${e.clientX}px`;
                        contextMenu.style.display = 'block';
                        contextMenu.dataset.songIndex = index;
                    });
                });
            }

            function updatePlaylistHighlight(playingIndex) { document.querySelectorAll('.song-list-table tbody tr').forEach(row => { row.classList.toggle('playing', parseInt(row.dataset.index) === playingIndex); }); }
            function formatTime(s) { if (isNaN(s)) return "0:00"; const m = Math.floor(s / 60); const secs = Math.floor(s % 60); return `${m}:${secs < 10 ? '0' : ''}${secs}`; }

            // --- Event Listeners & Initialization ---
            window.showArtistPage = showArtistPage;
            window.toggleAlbumInLibrary = toggleAlbumInLibrary;

            navItems.forEach(item => item.addEventListener('click', e => {
                navItems.forEach(nav => nav.classList.remove('active'));
                const navItem = e.currentTarget;
                navItem.classList.add('active');
                showPage(navItem.dataset.page);
                if (navItem.dataset.page === 'library') renderLibrary();
            }));

            playPauseBtn.addEventListener('click', togglePlayPause);
            nextBtn.addEventListener('click', playNextSong);
            prevBtn.addEventListener('click', playPrevSong);
            audioPlayer.addEventListener('ended', playNextSong);
            
            const progressBar = document.getElementById('progress-bar');
            const progress = document.getElementById('progress');
            const currentTimeEl = document.getElementById('current-time');
            const durationEl = document.getElementById('duration');
            audioPlayer.addEventListener('timeupdate', () => { progress.style.width = `${(audioPlayer.currentTime / audioPlayer.duration) * 100}%`; currentTimeEl.textContent = formatTime(audioPlayer.currentTime); });
            audioPlayer.addEventListener('loadedmetadata', () => { durationEl.textContent = formatTime(audioPlayer.duration); });
            progressBar.addEventListener('click', e => { if(audioPlayer.duration) audioPlayer.currentTime = (e.offsetX / progressBar.clientWidth) * audioPlayer.duration; });
            
            queueBtn.addEventListener('click', () => { renderQueueModal(); queueModal.style.display = 'flex'; });
            closeQueueBtn.addEventListener('click', () => queueModal.style.display = 'none');
            window.addEventListener('click', e => { 
                if (e.target === queueModal) queueModal.style.display = 'none';
                if (!contextMenu.contains(e.target)) contextMenu.style.display = 'none'; 
            });
            document.getElementById('play-next').addEventListener('click', () => { playNext(parseInt(contextMenu.dataset.songIndex)); contextMenu.style.display = 'none'; });
            document.getElementById('add-to-queue').addEventListener('click', () => { addToQueue(parseInt(contextMenu.dataset.songIndex)); contextMenu.style.display = 'none'; });
            
            loadLibrary();
            renderHomePage();
        });
    </script>
</body>
</html>
